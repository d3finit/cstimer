let themes = [
    {
        name: 'plus-giftwrap',
        code: 'eb2db7312b2225a6fee4cf3806493056',
        colors: [
            {
                prop: 'col-font',
                color: '#ffffff'
            },
            {
                prop: 'col-back',
                color: '#931b1b'
            },
            {
                prop: 'col-board',
                color: '#297f46'
            },
            {
                prop: 'col-button',
                color: '#931b1b'
            },
            {
                prop: 'col-link',
                color: '#000000'
            },
            {
                prop: 'col-logo',
                color: '#000000'
            },
            {
                prop: 'col-logoback',
                color: '#e1b23d'
            }
        ]
    },
    {
        name: 'plus-icecube',
        code: 'eb2db7312b2225a6fee4cf3806493056',
        colors: [
            {
                prop: 'col-font',
                color: '#1598bc'
            },
            {
                prop: 'col-back',
                color: '#b8ffff'
            },
            {
                prop: 'col-board',
                color: '#c7ffff'
            },
            {
                prop: 'col-button',
                color: '#adf4ff'
            },
            {
                prop: 'col-link',
                color: '#37cbe1'
            },
            {
                prop: 'col-logo',
                color: '#1598bc'
            },
            {
                prop: 'col-logoback',
                color: '#c7ffff'
            }
        ]
    },
    {
        name: 'plus-black',
        code: 'f5f75f1b95652443e4398974b82c3f7c',
        colors: [
            {
                prop: 'col-font',
                color: '#ffffff'
            },
            {
                prop: 'col-back',
                color: '#000000'
            },
            {
                prop: 'col-board',
                color: '#000000'
            },
            {
                prop: 'col-button',
                color: '#666666'
            },
            {
                prop: 'col-link',
                color: '#ffffff'
            },
            {
                prop: 'col-logo',
                color: '#ffffff'
            },
            {
                prop: 'col-logoback',
                color: '#000000'
            }
        ]
    },
    {
        name: 'plus-white',
        code: 'f5f75f1b95652443e4398974b82c3f7c',
        colors: [
            {
                prop: 'col-font',
                color: '#000000'
            },
            {
                prop: 'col-back',
                color: '#ffffff'
            },
            {
                prop: 'col-board',
                color: '#ffffff'
            },
            {
                prop: 'col-button',
                color: '#dddddd'
            },
            {
                prop: 'col-link',
                color: '#000000'
            },
            {
                prop: 'col-logo',
                color: '#000000'
            },
            {
                prop: 'col-logoback',
                color: '#ffffff'
            }
        ]
    },
    {
        name: 'plus-dark',
        colors: [
            {
                prop: 'col-font',
                color: '#99aaaa'
            },
            {
                prop: 'col-back',
                color: '#002233'
            },
            {
                prop: 'col-board',
                color: '#003344'
            },
            {
                prop: 'col-button',
                color: '#175473'
            },
            {
                prop: 'col-link',
                color: '#0d6a91'
            },
            {
                prop: 'col-logo',
                color: '#667788'
            },
            {
                prop: 'col-logoback',
                color: '#003344'
            }
        ]
    },
    {
        name: 'plus-light',
        colors: [
            {
                prop: 'col-font',
                color: '#5a584e'
            },
            {
                prop: 'col-back',
                color: '#c0bcaf'
            },
            {
                prop: 'col-board',
                color: '#dddbca'
            },
            {
                prop: 'col-button',
                color: '#e7dfc5'
            },
            {
                prop: 'col-link',
                color: '#755c00'
            },
            {
                prop: 'col-logo',
                color: '#77600e'
            },
            {
                prop: 'col-logoback',
                color: '#e2deca'
            }
        ]
    },
    {
        name: 'plus-rgb',
        code: '889574aebacda6bfd3e534e2b49b8028',
        colors: [
            {
                prop: 'col-font',
                color: '#828282'
            },
            {
                prop: 'col-back',
                color: '#000000'
            },
            {
                prop: 'col-board',
                color: '#000000'
            },
            {
                prop: 'col-button',
                color: '#2e2e2e'
            },
            {
                prop: 'col-link',
                color: '#c4c4c4'
            },
            {
                prop: 'col-logo',
                color: '#75de46'
            },
            {
                prop: 'col-logoback',
                color: '#000000'
            }
        ]
    },
    {
        name: 'plus-ween',
        colors: [
            {
                prop: 'col-font',
                color: '#ee8800'
            },
            {
                prop: 'col-back',
                color: '#111111'
            },
            {
                prop: 'col-board',
                color: '#551177'
            },
            {
                prop: 'col-button',
                color: '#440066'
            },
            {
                prop: 'col-link',
                color: '#ffffff'
            },
            {
                prop: 'col-logo',
                color: '#ffffff'
            },
            {
                prop: 'col-logoback',
                color: '#111111'
            }
        ]
    },
    {
        name: 'biocube',
        colors: [
            {
                prop: 'col-font',
                color: '#00ff00'
            },
            {
                prop: 'col-back',
                color: '#000000'
            },
            {
                prop: 'col-board',
                color: '#333333'
            },
            {
                prop: 'col-button',
                color: '#666666'
            },
            {
                prop: 'col-link',
                color: '#cccccc'
            },
            {
                prop: 'col-logo',
                color: '#00ff00'
            },
            {
                prop: 'col-logoback',
                color: '#333333'
            }
        ],
    },
    {
        name: 'cubovelocidade',
        lang: 'pt-pt',
        colors: [
            {
                prop: 'col-font',
                color: '#ffffff'
            },
            {
                prop: 'col-back',
                color: '#0099dd'
            },
            {
                prop: 'col-board',
                color: '#0066aa'
            },
            {
                prop: 'col-button',
                color: '#ff7700'
            },
            {
                prop: 'col-link',
                color: '#ffffff'
            },
            {
                prop: 'col-logo',
                color: '#ffffff'
            },
            {
                prop: 'col-logoback',
                color: '#000000'
            }
        ],
    },
    {
        name: 'purple',
        colors: [
            {
                prop: 'col-font',
                color: '#a098a9'
            },
            {
                prop: 'col-back',
                color: '#1a0033'
            },
            {
                prop: 'col-board',
                color: '#2b0042'
            },
            {
                prop: 'col-button',
                color: '#7100bd'
            },
            {
                prop: 'col-link',
                color: '#8022dd'
            },
            {
                prop: 'col-logo',
                color: '#4f0183'
            },
            {
                prop: 'col-logoback',
                color: '#240042'
            }
        ]
    },
    {
        name: 'sctheme',
        code: '7813bf2ae9a0feecce41ee7dcba740b3',
        colors: [
            {
                prop: 'col-font',
                color: '#00ddff'
            },
            {
                prop: 'col-back',
                color: '#000000'
            },
            {
                prop: 'col-board',
                color: '#000000'
            },
            {
                prop: 'col-button',
                color: '#000000'
            },
            {
                prop: 'col-link',
                color: '#00eeff'
            },
            {
                prop: 'col-logo',
                color: '#00eeff'
            },
            {
                prop: 'col-logoback',
                color: '#000000'
            }
        ]
    },
    {
        name: 'vicenzo',
        code: 'bddccbabd3f88635da6131272ef9b9b1',
        colors: [
            {
                prop: 'col-font',
                color: '#bb0000'
            },
            {
                prop: 'col-back',
                color: '#000000'
            },
            {
                prop: 'col-board',
                color: '#000000'
            },
            {
                prop: 'col-button',
                color: '#000000'
            },
            {
                prop: 'col-link',
                color: '#cc0000'
            },
            {
                prop: 'col-logo',
                color: '#cc0000'
            },
            {
                prop: 'col-logoback',
                color: '#000000'
            }
        ]
    },
]

function usingTheme(code) {
    if (kernel.getProp('color') == 'u') {
        let using = themes.filter((theme) => {
            if ("lang" in theme && theme.lang != kernel.getProp('lang')) return;
            if ("code" in theme && !code.hasCode(theme.code)) return;
            let match = true;
            let stop = false;
            theme.colors.map(c => {
                if (stop) return;
                if (kernel.getProp(c.prop) != c.color) {
                    match = false;
                    stop = true;
                }
            });
            return match;
        });
        if (using.length == 1) {
            $('select[name=color] option').removeAttr('selected').filter('[data-theme='+using[0].name+']').attr('selected', true);
        } else {
            $('select[name=color] option').removeAttr('selected').filter('[value=u]:not([data-theme])').attr('selected', true);
        }
    }
}

function addThemes(code) {
    themes.map(theme => {
        if ("lang" in theme && theme.lang != kernel.getProp('lang')) return;
        if ("code" in theme && !code.hasCode(theme.code)) return;
        let check = Boolean($('option[data-theme='+theme.name+']').length);
        if (check) return;
        $('select[name=color]').append('<option value="1" data-theme="'+theme.name+'">'+theme.name+'</option>');
    });
    usingTheme(code);
}

function addUi() {
    let check = Boolean($('option[data-ui]').length);
    if (check) return;
    $('select[name=uidesign]').append('<option value="ns" data-ui>csTimer+</option>');
    if (kernel.getProp('cspt')) $('select[name=uidesign] option').removeAttr('selected').filter('[data-ui]').attr('selected', true);
}

function addBgUpload() {
    let check = Boolean($('option[data-bgupload]').length);
    if (kernel.getProp('plusBgUpload')) {
        if (!Boolean($('option[data-bguploaded]').length)) {
            $('select[name=bgImgS] option').removeAttr('selected');
            $('select[name=bgImgS]').prepend('<option data-bguploaded selected>uploaded</option>');
        }
    } else {
        $('option[data-bguploaded]').remove();
    }
    if (check) return;
    $('<input type="file" name="bgImageUpload" accept="image/x-png,image/gif,image/jpeg" style="display: none"/>').insertBefore('select[name=bgImgS]');
    $('<option value="up" data-bgupload>upload</option>').insertAfter('select[name=bgImgS] > option[value=u]');
}

function relativeAlpha(hex, a = 0.5) {
    let r = 0, g = 0, b = 0;

    if (hex.length == 4) {
        r = "0x" + hex[1] + hex[1];
        g = "0x" + hex[2] + hex[2];
        b = "0x" + hex[3] + hex[3];
    } else if (hex.length == 7) {
        r = "0x" + hex[1] + hex[2];
        g = "0x" + hex[3] + hex[4];
        b = "0x" + hex[5] + hex[6];
    }

    r = Math.floor(r * a + 0xff * (1 - a));
    g = Math.floor(g * a + 0xff * (1 - a));
    b = Math.floor(b * a + 0xff * (1 - a));

    return "rgb("+ +r + "," + +g + "," + +b + ")";
}

let css = false;

function setColoredScramble() {
    let color = kernel.getProp('col-board');
    let font = kernel.getProp('col-font');
    let shadow = relativeAlpha(color, 0.9);
    if (!css) css = $('<style type="text/css"/>').appendTo('head');
    css.empty();
    css.append('.hl {background-color: '+relativeAlpha(color, 0.8)+' !important; color: '+font+' !important}');
    css.append('.trail {box-shadow: '+shadow+' 10px 0px 0px 0px, '+shadow+' 16px 0px 0px 0px !important; background-color: '+shadow+' !important; color: '+relativeAlpha(color, 0.3)+' !important}')
}

export function colors(plusLang = {}, code) {
    let uploadedBg = kernel.getProp('plusBgUpload');
    if (uploadedBg) $('#bgImage').attr('src', kernel.getProp('bgImgSrc'));
    setColoredScramble();
    kernel.regListener('adjustColors', 'property', setColoredScramble, /^col-[\w]+$/);
    if (kernel.getProp('cspt') && !$('html').hasClass('cspt')) {
        $('html').removeClass();
        $('html').addClass('cspt');
        $('html').addClass('p'+Math.floor(kernel.getProp('zoom')*100));
    }
    const dialog = $('#gray').get(0);
    const config = { attributes: true, childList: true, subtree: true };
    let dialogChange = function(mutationsList, observer) {
        for(let mutation of mutationsList) {
            if (mutation.type === 'attributes') {
                if ($('.dialog').hasClass('dialogoption')){
                    addThemes(code);
                    addUi();
                    addBgUpload();
                    $(document).trigger('addPeople');
                } else if ($('.dialog').hasClass('dialogstats')) {
                    let textarea = $('.dialogstats').find('textarea');
                    const regex = /(csTimer\s)/gm;
                    const subst = `csTimer+ `;
                    const result = textarea.val().replace(regex, subst);
                    textarea.val(result);
                    textarea.focus();
                    textarea.select();
                }
            }
        }
    };
    const dObs = new MutationObserver(dialogChange);
    dObs.observe(dialog, config);
    $('body').on('change', 'select[name=color]', function() {
        let option = $(this).find('option:selected');
        if (option.data().hasOwnProperty('theme')) {
            let theme = themes.filter(t => option.data('theme') == t.name);
            if (theme.length > 0) {
                theme = theme[0];
                theme.colors.map((c) => {
                    kernel.setProp(c.prop, c.color);
                });
                kernel.setProp('current-theme', theme.name);
                $('select[name=color] option').removeAttr('selected').filter('[data-theme='+theme.name+']').attr('selected', true);
            }
        } else {
            kernel.setProp('current-theme', option.val());
        }
        $(document).trigger('theme_changed', kernel.getProp('current-theme'));
        if (kernel.getProp('current-theme') == 'biocube') $(document).trigger('voice', ['THEME_BIOCUBE']);
        if (kernel.getProp('current-theme') == 'sctheme') $(document).trigger('voice', ['THEME_SUZANE']);
    });
    $('body').on('change', 'select[name=uidesign], select[name=introUi]', function() {
        let option = $(this).find('option:selected');
        if (option.data().hasOwnProperty('ui') || option.val() == 'y') {
            $('html').addClass('cspt');
            kernel.setProp('cspt', true);
        } else{
            $('html').removeClass('cspt');
            kernel.setProp('cspt', false);
        }
    });
    $('body').on('change', 'select[name=zoom]', function() {
        if (kernel.getProp('cspt') && !$('html').hasClass('cspt')) {
            $('html').removeClass();
            $('html').addClass('cspt');
            $('html').addClass('p'+Math.floor(kernel.getProp('zoom')*100));
        }
    });
    File.prototype.convertToBase64 = function(callback){
        let reader = new FileReader();
        reader.onloadend = function (e) {
            callback(e.target.result, e.target.error);
        };
        reader.readAsDataURL(this);
    };
    $('body').on('change', 'input[name=bgImageUpload]',function(){
        this.files[0].convertToBase64(function(base64){
            kernel.setProp('bgImgSrc', base64);
            $('#bgImage').attr('src', base64);
            $('select[name=bgImgS] option').removeAttr('selected');
            $('select[name=bgImgS]').prepend('<option data-bguploaded selected>uploaded</option>');
        })
    });
    $('body').on('change', 'select[name=bgImgS]', function(e) {
        if ($(this).find('option:selected').data().hasOwnProperty('bgupload')) {
            $('input[name=bgImageUpload]').trigger('click');
            kernel.setProp('plusBgUpload', true);
            e.preventDefault();
        } else {
            kernel.setProp('plusBgUpload', false);
        }
    });
    $('body').on('change', 'input[name=colclock], input[name=colsq2], input[name=colfto], select[name=logoFace]', function() {
        kernel.pushSignal('scramble', tools.getCurScramble());
    });
    var color = $('style:eq(0)');

    var csstmp =
        "html,body,textarea,#leftbar{color:?;background-color:?}" +
        "#leftbar{border-color:?}" +
        "#logo{color:?;border-color:?;background-color:?}" +
        ".mybutton,.tab,.cntbar{border-color:?}" +
        "html:not(.m) .mybutton:hover,.mybutton:active,.tab:active,.mywindow,.popup,.dialog{background-color:?}" +
        ".mybutton.enable,.tab.enable,.cntbar,.selected,table.opttable tr th:first-child,div.helptable h2,div.helptable h3{background-color:?}" +
        "#gray{background-color:?}" +
        "html:not(.m) .times:hover,html:not(.m) .click:hover,.times:active,.click:active,textarea{background-color:?}" +
        ".click{color:?}" +
        ".mywindow,.popup,.dialog,.table,.table td,.table th,textarea,.tabValue,.opttable td.sr{border-color:?}" +
        "html:not(.m) #avgstr .click:hover,#avgstr .click:active{background-color:?}" +
        "select,input[type='button'],input[type='text']{color:?;background:?;border-color:?}" +
        "input:disabled,table.opttable tr:nth-child(odd) td:first-child,div.helptable li:nth-child(odd){background:?}" +
        ".mywindow::before,.popup,.dialog,#leftbar::before";
    csstmp = [
        csstmp + "{box-shadow:0 0 .6em ?}",
        csstmp + "{box-shadow:none}"
    ];

    var styles = [
        "#000#efc#fdd#fbb#00f#ff0#000",
        "#000#ffe#ff9#ff0#00f#fa0#000",
        "#fff#600#668#408#ccf#0ff#000",
        "#fff#000#555#888#aaa#000#aaa",
        "#000#fff#ccc#ddd#555#fff#888",
        "#fff#227#9c3#563#580#dad#000",
        "#9aa#023#034#b80#28d#678#034",
        "#678#ffe#eed#ffe#28d#678#eed"
    ];

    var cur_color = [kernel.getProp('col-font'), kernel.getProp('col-back'), kernel.getProp('col-board'), kernel.getProp('col-button'), kernel.getProp('col-link'), kernel.getProp('col-logo'), kernel.getProp('col-logoback')];
    var col_map = [0, 1, 1|0x220, 5, 5|0x220, 6, 2|0x220, 2, 3, 0, 2|0x220, 4, 2|0x220, 1|0x220, 0, 2|0xef0, 2|0x220, 2|0x110, 0];
    var col_props = ['font', 'back', 'board', 'button', 'link', 'logo', 'logoback'];

    function setColor(idx, val) {
        val = nearColor(val);
        if (cur_color[idx] == val) {
            return;
        }
        cur_color[idx] = val;
        releaseColor();
    }

    function releaseColor() {
        var cssval = kernel.getProp('uidesign') == 'ns' || kernel.getProp('uidesign') == 'mtns' ? csstmp[1] : csstmp[0];
        var sgn = nearColor(cur_color[0]) == '#000' ? -1: 1;
        for (var i=0; i<col_map.length; i++) {
            cssval = cssval.replace('?', nearColor(cur_color[col_map[i] & 0xf], (col_map[i] << 20 >> 24) * sgn));
        }
        $(color).html(cssval);
        $(document).trigger('theme_changed', ['manual']);
    }

    function nearColor(color, ref, longFormat) {
        var col, m;
        ref = ref || 0;
        m = /^#([0-9a-fA-F])([0-9a-fA-F])([0-9a-fA-F])$/.exec(color);
        if (m) {
            col = [m[1] + m[1], m[2] + m[2], m[3] + m[3]];
        }
        m = /^#([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/.exec(color);
        if (m) {
            col = [m[1], m[2], m[3]];
        }
        for (var i=0; i<3; i++) {
            col[i] = parseInt(col[i], 16);
            col[i] += ref;
            col[i] = Math.min(Math.max(col[i], 0), 255);
            col[i] = (Math.round(col[i]/17)).toString(16);
        }
        return "#" + (longFormat ? col[0] + col[0] + col[1] + col[1] + col[2] + col[2] : col[0] + col[1] + col[2]);
    }
    $('body').off('input', 'input[type=color]').on('input', 'input[type=color]', function() {
        if ($(this).attr('name').substr(0,4) !== 'col-') return;
        setColor(col_props.indexOf($(this).attr('name').substring(4, $(this).attr('name').length)), $(this).val());
    });
}